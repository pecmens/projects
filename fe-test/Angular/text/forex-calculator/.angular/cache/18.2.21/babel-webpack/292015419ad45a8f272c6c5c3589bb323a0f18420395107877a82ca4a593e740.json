{"ast":null,"code":"import { Observable, BehaviorSubject, timer, of } from 'rxjs';\nimport { switchMap, shareReplay, catchError } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport let ForexService = /*#__PURE__*/(() => {\n  class ForexService {\n    constructor(http) {\n      this.http = http;\n      this.API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';\n      this.ALTERNATIVE_API = 'https://open.er-api.com/v6/latest/USD';\n      this.ratesSubject = new BehaviorSubject([]);\n      this.rates$ = this.ratesSubject.asObservable();\n      this.lastUpdateSubject = new BehaviorSubject(new Date());\n      this.lastUpdate$ = this.lastUpdateSubject.asObservable();\n      this.previousRates = {};\n      this.startRealTimeUpdates();\n    }\n    getForexRates() {\n      return timer(0, 30000).pipe(switchMap(() => this.fetchRates()), shareReplay(1), catchError(error => {\n        console.error('获取外汇汇率失败:', error);\n        return this.getFallbackRates();\n      }));\n    }\n    fetchRates() {\n      return this.http.get(this.API_URL).pipe(switchMap(response => {\n        if (response.success) {\n          return this.processRates(response.rates);\n        } else {\n          return this.fetchAlternativeRates();\n        }\n      }), catchError(() => this.fetchAlternativeRates()));\n    }\n    fetchAlternativeRates() {\n      return this.http.get(this.ALTERNATIVE_API).pipe(switchMap(response => {\n        if (response.rates) {\n          return this.processRates(response.rates);\n        }\n        throw new Error('无法获取汇率数据');\n      }), catchError(() => this.getFallbackRates()));\n    }\n    processRates(rates) {\n      const forexRates = [];\n      const commonCurrencies = ['CNY', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'HKD', 'SGD', 'KRW'];\n      commonCurrencies.forEach(currency => {\n        if (rates[currency]) {\n          const currentRate = rates[currency];\n          const previousRate = this.previousRates[currency] || currentRate;\n          const change = currentRate - previousRate;\n          const changePercent = previousRate !== 0 ? change / previousRate * 100 : 0;\n          forexRates.push({\n            currency,\n            rate: currentRate,\n            change,\n            changePercent,\n            timestamp: new Date()\n          });\n          this.previousRates[currency] = currentRate;\n        }\n      });\n      this.ratesSubject.next(forexRates);\n      this.lastUpdateSubject.next(new Date());\n      return new Observable(observer => {\n        observer.next(forexRates);\n        observer.complete();\n      });\n    }\n    getFallbackRates() {\n      const fallbackRates = [{\n        currency: 'CNY',\n        rate: 7.25,\n        change: 0.01,\n        changePercent: 0.14,\n        timestamp: new Date()\n      }, {\n        currency: 'EUR',\n        rate: 0.92,\n        change: -0.002,\n        changePercent: -0.22,\n        timestamp: new Date()\n      }, {\n        currency: 'GBP',\n        rate: 0.79,\n        change: 0.003,\n        changePercent: 0.38,\n        timestamp: new Date()\n      }, {\n        currency: 'JPY',\n        rate: 149.50,\n        change: 0.50,\n        changePercent: 0.34,\n        timestamp: new Date()\n      }, {\n        currency: 'AUD',\n        rate: 1.52,\n        change: -0.01,\n        changePercent: -0.65,\n        timestamp: new Date()\n      }, {\n        currency: 'CAD',\n        rate: 1.36,\n        change: 0.002,\n        changePercent: 0.15,\n        timestamp: new Date()\n      }, {\n        currency: 'CHF',\n        rate: 0.88,\n        change: -0.001,\n        changePercent: -0.11,\n        timestamp: new Date()\n      }, {\n        currency: 'HKD',\n        rate: 7.80,\n        change: 0.01,\n        changePercent: 0.13,\n        timestamp: new Date()\n      }, {\n        currency: 'SGD',\n        rate: 1.35,\n        change: 0.002,\n        changePercent: 0.15,\n        timestamp: new Date()\n      }, {\n        currency: 'KRW',\n        rate: 1290.00,\n        change: 5.00,\n        changePercent: 0.39,\n        timestamp: new Date()\n      }];\n      this.ratesSubject.next(fallbackRates);\n      this.lastUpdateSubject.next(new Date());\n      return new Observable(observer => {\n        observer.next(fallbackRates);\n        observer.complete();\n      });\n    }\n    convertCurrency(fromCurrency, toCurrency, amount) {\n      return this.rates$.pipe(switchMap(rates => {\n        const fromRate = rates.find(r => r.currency === fromCurrency);\n        const toRate = rates.find(r => r.currency === toCurrency);\n        if (!fromRate || !toRate) {\n          throw new Error(`无法找到 ${fromCurrency} 或 ${toCurrency} 的汇率`);\n        }\n        const usdAmount = amount / fromRate.rate;\n        const convertedAmount = usdAmount * toRate.rate;\n        return of(convertedAmount);\n      }));\n    }\n    startRealTimeUpdates() {\n      this.getForexRates().subscribe();\n    }\n    static {\n      this.ɵfac = function ForexService_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || ForexService)(i0.ɵɵinject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: ForexService,\n        factory: ForexService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return ForexService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}