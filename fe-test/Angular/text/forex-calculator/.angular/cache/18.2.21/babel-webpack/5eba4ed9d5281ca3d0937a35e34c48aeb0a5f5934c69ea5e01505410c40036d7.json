{"ast":null,"code":"import { Observable, BehaviorSubject, timer, of } from 'rxjs';\nimport { switchMap, shareReplay, catchError } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class ForexService {\n  constructor(http) {\n    this.http = http;\n    this.API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';\n    this.ALTERNATIVE_API = 'https://open.er-api.com/v6/latest/USD';\n    this.ratesSubject = new BehaviorSubject([]);\n    this.rates$ = this.ratesSubject.asObservable();\n    this.lastUpdateSubject = new BehaviorSubject(new Date());\n    this.lastUpdate$ = this.lastUpdateSubject.asObservable();\n    this.previousRates = {};\n    this.startRealTimeUpdates();\n  }\n  getForexRates() {\n    return timer(0, 30000).pipe(switchMap(() => this.fetchRates()), shareReplay(1), catchError(error => {\n      console.error('获取外汇汇率失败:', error);\n      return this.getFallbackRates();\n    }));\n  }\n  fetchRates() {\n    return this.http.get(this.API_URL).pipe(switchMap(response => {\n      if (response.success) {\n        return this.processRates(response.rates);\n      } else {\n        return this.fetchAlternativeRates();\n      }\n    }), catchError(() => this.fetchAlternativeRates()));\n  }\n  fetchAlternativeRates() {\n    return this.http.get(this.ALTERNATIVE_API).pipe(switchMap(response => {\n      if (response.rates) {\n        return this.processRates(response.rates);\n      }\n      throw new Error('无法获取汇率数据');\n    }), catchError(() => this.getFallbackRates()));\n  }\n  processRates(rates) {\n    const forexRates = [];\n    const commonCurrencies = ['CNY', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'HKD', 'SGD', 'KRW'];\n    commonCurrencies.forEach(currency => {\n      if (rates[currency]) {\n        const currentRate = rates[currency];\n        const previousRate = this.previousRates[currency] || currentRate;\n        const change = currentRate - previousRate;\n        const changePercent = previousRate !== 0 ? change / previousRate * 100 : 0;\n        forexRates.push({\n          currency,\n          rate: currentRate,\n          change,\n          changePercent,\n          timestamp: new Date()\n        });\n        this.previousRates[currency] = currentRate;\n      }\n    });\n    this.ratesSubject.next(forexRates);\n    this.lastUpdateSubject.next(new Date());\n    return new Observable(observer => {\n      observer.next(forexRates);\n      observer.complete();\n    });\n  }\n  getFallbackRates() {\n    const fallbackRates = [{\n      currency: 'CNY',\n      rate: 7.25,\n      change: 0.01,\n      changePercent: 0.14,\n      timestamp: new Date()\n    }, {\n      currency: 'EUR',\n      rate: 0.92,\n      change: -0.002,\n      changePercent: -0.22,\n      timestamp: new Date()\n    }, {\n      currency: 'GBP',\n      rate: 0.79,\n      change: 0.003,\n      changePercent: 0.38,\n      timestamp: new Date()\n    }, {\n      currency: 'JPY',\n      rate: 149.50,\n      change: 0.50,\n      changePercent: 0.34,\n      timestamp: new Date()\n    }, {\n      currency: 'AUD',\n      rate: 1.52,\n      change: -0.01,\n      changePercent: -0.65,\n      timestamp: new Date()\n    }, {\n      currency: 'CAD',\n      rate: 1.36,\n      change: 0.002,\n      changePercent: 0.15,\n      timestamp: new Date()\n    }, {\n      currency: 'CHF',\n      rate: 0.88,\n      change: -0.001,\n      changePercent: -0.11,\n      timestamp: new Date()\n    }, {\n      currency: 'HKD',\n      rate: 7.80,\n      change: 0.01,\n      changePercent: 0.13,\n      timestamp: new Date()\n    }, {\n      currency: 'SGD',\n      rate: 1.35,\n      change: 0.002,\n      changePercent: 0.15,\n      timestamp: new Date()\n    }, {\n      currency: 'KRW',\n      rate: 1290.00,\n      change: 5.00,\n      changePercent: 0.39,\n      timestamp: new Date()\n    }];\n    this.ratesSubject.next(fallbackRates);\n    this.lastUpdateSubject.next(new Date());\n    return new Observable(observer => {\n      observer.next(fallbackRates);\n      observer.complete();\n    });\n  }\n  convertCurrency(fromCurrency, toCurrency, amount) {\n    return this.rates$.pipe(switchMap(rates => {\n      const fromRate = rates.find(r => r.currency === fromCurrency);\n      const toRate = rates.find(r => r.currency === toCurrency);\n      if (!fromRate || !toRate) {\n        throw new Error(`无法找到 ${fromCurrency} 或 ${toCurrency} 的汇率`);\n      }\n      const usdAmount = amount / fromRate.rate;\n      const convertedAmount = usdAmount * toRate.rate;\n      return of(convertedAmount);\n    }));\n  }\n  startRealTimeUpdates() {\n    this.getForexRates().subscribe();\n  }\n  static {\n    this.ɵfac = function ForexService_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || ForexService)(i0.ɵɵinject(i1.HttpClient));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: ForexService,\n      factory: ForexService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["Observable","BehaviorSubject","timer","of","switchMap","shareReplay","catchError","ForexService","constructor","http","API_URL","ALTERNATIVE_API","ratesSubject","rates$","asObservable","lastUpdateSubject","Date","lastUpdate$","previousRates","startRealTimeUpdates","getForexRates","pipe","fetchRates","error","console","getFallbackRates","get","response","success","processRates","rates","fetchAlternativeRates","Error","forexRates","commonCurrencies","forEach","currency","currentRate","previousRate","change","changePercent","push","rate","timestamp","next","observer","complete","fallbackRates","convertCurrency","fromCurrency","toCurrency","amount","fromRate","find","r","toRate","usdAmount","convertedAmount","subscribe","i0","ɵɵinject","i1","HttpClient","factory","ɵfac","providedIn"],"sources":["E:\\code\\fe-test\\Angular\\text\\forex-calculator\\src\\app\\services\\forex.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, BehaviorSubject, timer, of } from 'rxjs';\r\nimport { switchMap, shareReplay, catchError } from 'rxjs/operators';\r\nexport interface ForexRate {\r\n  currency: string;\r\n  rate: number;\r\n  change: number;\r\n  changePercent: number;\r\n  timestamp: Date;\r\n}\r\n\r\nexport interface ForexResponse {\r\n  success: boolean;\r\n  rates: { [key: string]: number };\r\n  base?: string;\r\n  date?: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ForexService {\r\n  private readonly API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';\r\n  private readonly ALTERNATIVE_API = 'https://open.er-api.com/v6/latest/USD';\r\n  \r\n  private ratesSubject = new BehaviorSubject<ForexRate[]>([]);\r\n  public rates$ = this.ratesSubject.asObservable();\r\n  \r\n  private lastUpdateSubject = new BehaviorSubject<Date>(new Date());\r\n  public lastUpdate$ = this.lastUpdateSubject.asObservable();\r\n\r\n  private previousRates: { [key: string]: number } = {};\r\n\r\n  constructor(private http: HttpClient) {\r\n    this.startRealTimeUpdates();\r\n  }\r\n\r\n  getForexRates(): Observable<ForexRate[]> {\r\n    return timer(0, 30000).pipe(\r\n      switchMap(() => this.fetchRates()),\r\n      shareReplay(1),\r\n      catchError(error => {\r\n        console.error('获取外汇汇率失败:', error);\r\n        return this.getFallbackRates();\r\n      })\r\n    );\r\n  }\r\n\r\n  private fetchRates(): Observable<ForexRate[]> {\r\n    return this.http.get<ForexResponse>(this.API_URL).pipe(\r\n      switchMap(response => {\r\n        if (response.success) {\r\n          return this.processRates(response.rates);\r\n        } else {\r\n          return this.fetchAlternativeRates();\r\n        }\r\n      }),\r\n      catchError(() => this.fetchAlternativeRates())\r\n    );\r\n  }\r\n\r\n  private fetchAlternativeRates(): Observable<ForexRate[]> {\r\n    return this.http.get<ForexResponse>(this.ALTERNATIVE_API).pipe(\r\n      switchMap(response => {\r\n        if (response.rates) {\r\n          return this.processRates(response.rates);\r\n        }\r\n        throw new Error('无法获取汇率数据');\r\n      }),\r\n      catchError(() => this.getFallbackRates())\r\n    );\r\n  }\r\n\r\n  private processRates(rates: { [key: string]: number }): Observable<ForexRate[]> {\r\n    const forexRates: ForexRate[] = [];\r\n    const commonCurrencies = ['CNY', 'EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'HKD', 'SGD', 'KRW'];\r\n\r\n    commonCurrencies.forEach(currency => {\r\n      if (rates[currency]) {\r\n        const currentRate = rates[currency];\r\n        const previousRate = this.previousRates[currency] || currentRate;\r\n        const change = currentRate - previousRate;\r\n        const changePercent = previousRate !== 0 ? (change / previousRate) * 100 : 0;\r\n\r\n        forexRates.push({\r\n          currency,\r\n          rate: currentRate,\r\n          change,\r\n          changePercent,\r\n          timestamp: new Date()\r\n        });\r\n\r\n        this.previousRates[currency] = currentRate;\r\n      }\r\n    });\r\n\r\n    this.ratesSubject.next(forexRates);\r\n    this.lastUpdateSubject.next(new Date());\r\n\r\n    return new Observable(observer => {\r\n      observer.next(forexRates);\r\n      observer.complete();\r\n    });\r\n  }\r\n\r\n  private getFallbackRates(): Observable<ForexRate[]> {\r\n    const fallbackRates: ForexRate[] = [\r\n      { currency: 'CNY', rate: 7.25, change: 0.01, changePercent: 0.14, timestamp: new Date() },\r\n      { currency: 'EUR', rate: 0.92, change: -0.002, changePercent: -0.22, timestamp: new Date() },\r\n      { currency: 'GBP', rate: 0.79, change: 0.003, changePercent: 0.38, timestamp: new Date() },\r\n      { currency: 'JPY', rate: 149.50, change: 0.50, changePercent: 0.34, timestamp: new Date() },\r\n      { currency: 'AUD', rate: 1.52, change: -0.01, changePercent: -0.65, timestamp: new Date() },\r\n      { currency: 'CAD', rate: 1.36, change: 0.002, changePercent: 0.15, timestamp: new Date() },\r\n      { currency: 'CHF', rate: 0.88, change: -0.001, changePercent: -0.11, timestamp: new Date() },\r\n      { currency: 'HKD', rate: 7.80, change: 0.01, changePercent: 0.13, timestamp: new Date() },\r\n      { currency: 'SGD', rate: 1.35, change: 0.002, changePercent: 0.15, timestamp: new Date() },\r\n      { currency: 'KRW', rate: 1290.00, change: 5.00, changePercent: 0.39, timestamp: new Date() }\r\n    ];\r\n\r\n    this.ratesSubject.next(fallbackRates);\r\n    this.lastUpdateSubject.next(new Date());\r\n\r\n    return new Observable(observer => {\r\n      observer.next(fallbackRates);\r\n      observer.complete();\r\n    });\r\n  }\r\n\r\n  convertCurrency(fromCurrency: string, toCurrency: string, amount: number): Observable<number> {\r\n    return this.rates$.pipe(\r\n      switchMap(rates => {\r\n        const fromRate = rates.find(r => r.currency === fromCurrency);\r\n        const toRate = rates.find(r => r.currency === toCurrency);\r\n\r\n        if (!fromRate || !toRate) {\r\n          throw new Error(`无法找到 ${fromCurrency} 或 ${toCurrency} 的汇率`);\r\n        }\r\n\r\n        const usdAmount = amount / fromRate.rate;\r\n        const convertedAmount = usdAmount * toRate.rate;\r\n\r\n        return of(convertedAmount);\r\n      })\r\n    );\r\n  }\r\n\r\n  private startRealTimeUpdates(): void {\r\n    this.getForexRates().subscribe();\r\n  }\r\n}\r\n"],"mappings":"AAEA,SAASA,UAAU,EAAEC,eAAe,EAAEC,KAAK,EAAEC,EAAE,QAAQ,MAAM;AAC7D,SAASC,SAAS,EAAEC,WAAW,EAAEC,UAAU,QAAQ,gBAAgB;;;AAmBnE,OAAM,MAAOC,YAAY;EAYvBC,YAAoBC,IAAgB;IAAhB,KAAAA,IAAI,GAAJA,IAAI;IAXP,KAAAC,OAAO,GAAG,gDAAgD;IAC1D,KAAAC,eAAe,GAAG,uCAAuC;IAElE,KAAAC,YAAY,GAAG,IAAIX,eAAe,CAAc,EAAE,CAAC;IACpD,KAAAY,MAAM,GAAG,IAAI,CAACD,YAAY,CAACE,YAAY,EAAE;IAExC,KAAAC,iBAAiB,GAAG,IAAId,eAAe,CAAO,IAAIe,IAAI,EAAE,CAAC;IAC1D,KAAAC,WAAW,GAAG,IAAI,CAACF,iBAAiB,CAACD,YAAY,EAAE;IAElD,KAAAI,aAAa,GAA8B,EAAE;IAGnD,IAAI,CAACC,oBAAoB,EAAE;EAC7B;EAEAC,aAAaA,CAAA;IACX,OAAOlB,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC,CAACmB,IAAI,CACzBjB,SAAS,CAAC,MAAM,IAAI,CAACkB,UAAU,EAAE,CAAC,EAClCjB,WAAW,CAAC,CAAC,CAAC,EACdC,UAAU,CAACiB,KAAK,IAAG;MACjBC,OAAO,CAACD,KAAK,CAAC,WAAW,EAAEA,KAAK,CAAC;MACjC,OAAO,IAAI,CAACE,gBAAgB,EAAE;IAChC,CAAC,CAAC,CACH;EACH;EAEQH,UAAUA,CAAA;IAChB,OAAO,IAAI,CAACb,IAAI,CAACiB,GAAG,CAAgB,IAAI,CAAChB,OAAO,CAAC,CAACW,IAAI,CACpDjB,SAAS,CAACuB,QAAQ,IAAG;MACnB,IAAIA,QAAQ,CAACC,OAAO,EAAE;QACpB,OAAO,IAAI,CAACC,YAAY,CAACF,QAAQ,CAACG,KAAK,CAAC;MAC1C,CAAC,MAAM;QACL,OAAO,IAAI,CAACC,qBAAqB,EAAE;MACrC;IACF,CAAC,CAAC,EACFzB,UAAU,CAAC,MAAM,IAAI,CAACyB,qBAAqB,EAAE,CAAC,CAC/C;EACH;EAEQA,qBAAqBA,CAAA;IAC3B,OAAO,IAAI,CAACtB,IAAI,CAACiB,GAAG,CAAgB,IAAI,CAACf,eAAe,CAAC,CAACU,IAAI,CAC5DjB,SAAS,CAACuB,QAAQ,IAAG;MACnB,IAAIA,QAAQ,CAACG,KAAK,EAAE;QAClB,OAAO,IAAI,CAACD,YAAY,CAACF,QAAQ,CAACG,KAAK,CAAC;MAC1C;MACA,MAAM,IAAIE,KAAK,CAAC,UAAU,CAAC;IAC7B,CAAC,CAAC,EACF1B,UAAU,CAAC,MAAM,IAAI,CAACmB,gBAAgB,EAAE,CAAC,CAC1C;EACH;EAEQI,YAAYA,CAACC,KAAgC;IACnD,MAAMG,UAAU,GAAgB,EAAE;IAClC,MAAMC,gBAAgB,GAAG,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC;IAE/FA,gBAAgB,CAACC,OAAO,CAACC,QAAQ,IAAG;MAClC,IAAIN,KAAK,CAACM,QAAQ,CAAC,EAAE;QACnB,MAAMC,WAAW,GAAGP,KAAK,CAACM,QAAQ,CAAC;QACnC,MAAME,YAAY,GAAG,IAAI,CAACpB,aAAa,CAACkB,QAAQ,CAAC,IAAIC,WAAW;QAChE,MAAME,MAAM,GAAGF,WAAW,GAAGC,YAAY;QACzC,MAAME,aAAa,GAAGF,YAAY,KAAK,CAAC,GAAIC,MAAM,GAAGD,YAAY,GAAI,GAAG,GAAG,CAAC;QAE5EL,UAAU,CAACQ,IAAI,CAAC;UACdL,QAAQ;UACRM,IAAI,EAAEL,WAAW;UACjBE,MAAM;UACNC,aAAa;UACbG,SAAS,EAAE,IAAI3B,IAAI;SACpB,CAAC;QAEF,IAAI,CAACE,aAAa,CAACkB,QAAQ,CAAC,GAAGC,WAAW;MAC5C;IACF,CAAC,CAAC;IAEF,IAAI,CAACzB,YAAY,CAACgC,IAAI,CAACX,UAAU,CAAC;IAClC,IAAI,CAAClB,iBAAiB,CAAC6B,IAAI,CAAC,IAAI5B,IAAI,EAAE,CAAC;IAEvC,OAAO,IAAIhB,UAAU,CAAC6C,QAAQ,IAAG;MAC/BA,QAAQ,CAACD,IAAI,CAACX,UAAU,CAAC;MACzBY,QAAQ,CAACC,QAAQ,EAAE;IACrB,CAAC,CAAC;EACJ;EAEQrB,gBAAgBA,CAAA;IACtB,MAAMsB,aAAa,GAAgB,CACjC;MAAEX,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,IAAI;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EACzF;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,CAAC,KAAK;MAAEC,aAAa,EAAE,CAAC,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC5F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,KAAK;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC1F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,MAAM;MAAEH,MAAM,EAAE,IAAI;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC3F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,CAAC,IAAI;MAAEC,aAAa,EAAE,CAAC,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC3F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,KAAK;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC1F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,CAAC,KAAK;MAAEC,aAAa,EAAE,CAAC,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC5F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,IAAI;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EACzF;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,IAAI;MAAEH,MAAM,EAAE,KAAK;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,EAC1F;MAAEoB,QAAQ,EAAE,KAAK;MAAEM,IAAI,EAAE,OAAO;MAAEH,MAAM,EAAE,IAAI;MAAEC,aAAa,EAAE,IAAI;MAAEG,SAAS,EAAE,IAAI3B,IAAI;IAAE,CAAE,CAC7F;IAED,IAAI,CAACJ,YAAY,CAACgC,IAAI,CAACG,aAAa,CAAC;IACrC,IAAI,CAAChC,iBAAiB,CAAC6B,IAAI,CAAC,IAAI5B,IAAI,EAAE,CAAC;IAEvC,OAAO,IAAIhB,UAAU,CAAC6C,QAAQ,IAAG;MAC/BA,QAAQ,CAACD,IAAI,CAACG,aAAa,CAAC;MAC5BF,QAAQ,CAACC,QAAQ,EAAE;IACrB,CAAC,CAAC;EACJ;EAEAE,eAAeA,CAACC,YAAoB,EAAEC,UAAkB,EAAEC,MAAc;IACtE,OAAO,IAAI,CAACtC,MAAM,CAACQ,IAAI,CACrBjB,SAAS,CAAC0B,KAAK,IAAG;MAChB,MAAMsB,QAAQ,GAAGtB,KAAK,CAACuB,IAAI,CAACC,CAAC,IAAIA,CAAC,CAAClB,QAAQ,KAAKa,YAAY,CAAC;MAC7D,MAAMM,MAAM,GAAGzB,KAAK,CAACuB,IAAI,CAACC,CAAC,IAAIA,CAAC,CAAClB,QAAQ,KAAKc,UAAU,CAAC;MAEzD,IAAI,CAACE,QAAQ,IAAI,CAACG,MAAM,EAAE;QACxB,MAAM,IAAIvB,KAAK,CAAC,QAAQiB,YAAY,MAAMC,UAAU,MAAM,CAAC;MAC7D;MAEA,MAAMM,SAAS,GAAGL,MAAM,GAAGC,QAAQ,CAACV,IAAI;MACxC,MAAMe,eAAe,GAAGD,SAAS,GAAGD,MAAM,CAACb,IAAI;MAE/C,OAAOvC,EAAE,CAACsD,eAAe,CAAC;IAC5B,CAAC,CAAC,CACH;EACH;EAEQtC,oBAAoBA,CAAA;IAC1B,IAAI,CAACC,aAAa,EAAE,CAACsC,SAAS,EAAE;EAClC;;;uCA/HWnD,YAAY,EAAAoD,EAAA,CAAAC,QAAA,CAAAC,EAAA,CAAAC,UAAA;IAAA;EAAA;;;aAAZvD,YAAY;MAAAwD,OAAA,EAAZxD,YAAY,CAAAyD,IAAA;MAAAC,UAAA,EAFX;IAAM;EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}