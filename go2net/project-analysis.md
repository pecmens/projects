# 项目分析报告：file-transfer-go 到 .NET ABP.io 重构

## 1. 原项目概述

**文件快传**是一个基于WebRTC的P2P文件传输工具，提供安全、快速、简单的点对点文件传输解决方案，无需注册，即传即用。

### 核心功能
- 📁 **文件传输** - 支持多文件同时传输
- 📝 **文字传输** - 快速分享文本内容
- 🖥️ **桌面共享** - 实时屏幕共享
- 🔗 **连接状态同步** - 实时连接状态UI同步
- 🔒 **端到端加密** - 数据传输安全，服务器不存储文件
- 📱 **响应式设计** - 完美适配手机、平板、电脑
- 🖥️ **多平台支持** - 支持linux/macos/win 单文件部署

## 2. 技术架构分析

### 2.1 后端架构 (Go)

**目录结构：**
```
cmd/
  ├── config.go      - 配置管理
  ├── main.go        - 应用入口
  ├── router.go      - 路由设置
  └── server.go      - 服务器实现
internal/
  ├── handlers/
  │   └── handlers.go - HTTP/WebSocket处理器
  ├── services/
  │   └── webrtc_service.go - WebRTC信令服务
  └── web/
      └── frontend.go - 前端资源服务
```

**核心组件：**
1. **配置管理** - 支持环境变量、配置文件和命令行参数
2. **路由系统** - 使用chi框架，提供API路由和中间件
3. **WebSocket服务** - 处理WebRTC信令
4. **房间管理** - 创建、维护和清理WebRTC房间
5. **静态资源服务** - 提供前端文件服务

### 2.2 前端架构 (Next.js)

**核心功能模块：**
1. **WebRTC连接管理**
   - 连接建立与状态管理
   - 信令交换
   - 数据通道管理

2. **文件传输**
   - 文件分块处理 (256KB/块)
   - 传输进度跟踪
   - 完整性校验 (CRC32)
   - 可靠传输机制 (ACK确认)

3. **文字传输**
   - 文本内容发送与接收
   - 图像预览支持

4. **桌面共享**
   - 屏幕捕获
   - 视频流传输

5. **用户界面**
   - 响应式设计
   - 状态可视化
   - 设置管理

## 3. 业务流程分析

### 3.1 房间创建与连接流程

1. **创建房间**
   - 发送方通过API创建6位取件码的房间
   - 房间默认1小时后过期
   - 服务器返回房间码给发送方

2. **连接建立**
   - 发送方和接收方通过WebSocket连接到服务器
   - 连接时需要提供房间码和角色（sender/receiver）
   - 服务器验证房间是否存在且未过期
   - 服务器将客户端加入对应房间

3. **WebRTC信令交换**
   - 发送方创建Offer并发送给服务器
   - 服务器将Offer转发给接收方
   - 接收方创建Answer并发送给服务器
   - 服务器将Answer转发给发送方
   - 双方交换ICE候选信息
   - 建立P2P连接和数据通道

### 3.2 文件传输流程

1. **发送方流程**
   - 选择文件并切片（256KB/块）
   - 计算文件元数据和校验和
   - 发送文件元数据给接收方
   - 分块发送文件数据
   - 等待接收方的块确认
   - 失败时自动重试（最多5次）

2. **接收方流程**
   - 接收文件元数据
   - 准备接收文件块
   - 接收并验证每个文件块
   - 发送块确认信息
   - 所有块接收完成后组装文件
   - 计算校验和验证文件完整性

### 3.3 桌面共享流程

1. **共享方流程**
   - 请求屏幕共享权限
   - 获取屏幕媒体流
   - 将媒体流添加到WebRTC连接
   - 实时传输屏幕内容

2. **查看方流程**
   - 接收远程媒体流
   - 渲染共享屏幕
   - 处理连接中断和恢复

## 4. 关键技术点

### 4.1 WebRTC实现
- 使用RTCPeerConnection建立P2P连接
- 使用RTCDataChannel传输数据
- 使用媒体轨道传输桌面共享
- 自定义STUN/TURN服务器配置

### 4.2 可靠传输机制
- 文件分块传输
- 块确认机制
- CRC32校验和验证
- 自动重试逻辑
- 连接恢复支持

### 4.3 房间管理
- 6位随机取件码生成
- 房间过期自动清理
- 房间状态查询
- 连接断开处理

## 5. .NET ABP.io重构规划

### 5.1 架构设计

**后端架构：**
- ABP.io 模块化架构
- WebSocket支持
- 房间管理服务
- 信令转发服务

**前端架构：**
- React + TypeScript
- 保持原有WebRTC逻辑
- 适配新的后端API

### 5.2 数据模型

1. **Room模型**
   - 房间码
   - 创建时间
   - 过期时间
   - 发送方连接状态
   - 接收方连接状态

2. **Client模型**
   - 客户端ID
   - 角色（发送方/接收方）
   - 连接状态
   - 房间关联

### 5.3 API设计

1. **房间管理API**
   - 创建房间
   - 查询房间状态

2. **WebSocket端点**
   - WebRTC信令通道
   - 连接状态通知

### 5.4 关键挑战与解决方案

1. **WebSocket实现**
   - 使用ASP.NET Core SignalR
   - 支持分组和消息转发

2. **内存管理**
   - 使用内存缓存存储房间信息
   - 定期清理过期房间

3. **性能优化**
   - 异步处理WebSocket消息
   - 高效的信令转发
   - 连接池管理

## 6. 重构路线图

1. **准备阶段**
   - 创建ABP.io项目
   - 设置开发环境

2. **核心服务开发**
   - 房间管理服务
   - WebSocket信令服务

3. **API实现**
   - REST API
   - WebSocket端点

4. **前端适配**
   - 保持现有WebRTC逻辑
   - 更新API调用

5. **测试与优化**
   - 功能测试
   - 性能测试
   - 安全审查

6. **部署**
   - Docker配置
   - CI/CD流程

---

本分析报告提供了原项目的全面了解，为.NET ABP.io重构提供了清晰的路线图和技术指导。