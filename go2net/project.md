# 项目架构与功能说明

## 1. 项目背景与目标

### 1.1 项目背景
本项目源于现有的Go语言file-transfer-go项目，该项目已实现了基于WebRTC的文件传输功能，并且代码稳定运行。为了扩展项目功能、提高开发效率和利用.NET生态系统的优势，决定将项目重构为.NET ABP.io版本。

### 1.2 项目目标
- **功能完整性**：确保重构后的.NET版本完整实现原有功能
- **架构现代化**：采用ABP.io框架构建模块化、可扩展的架构
- **性能优化**：利用.NET平台优势优化文件传输性能
- **可维护性**：提高代码质量和可维护性
- **用户体验**：保持并提升用户界面体验

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端应用                               │
│  ┌─────────────┐  ┌─────────────┐  ┌───────────────────────┐  │
│  │ Web浏览器   │  │ 文件选择器  │  │ WebRTC客户端组件      │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬────────────┘  │
│         │               │                    │                 │
│         └───────────────┼────────────────────┘                 │
│                         │                                      │
│                         ▼                                      │
│                   ┌─────────────┐                              │
│                   │ 用户界面层  │                              │
│                   └─────────────┘                              │
└───────────────────────┬─────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        服务端应用                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      API网关层                           │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │    │
│  │  │ 路由转发    │  │ 认证授权    │  │ 流量控制    │      │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │    │
│  └──────────┬────────────────────┬────────────────┬───────┘    │
│             │                    │                │             │
│             ▼                    ▼                ▼             │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │ 用户管理服务   │  │ 文件传输服务   │  │ 配置管理服务   │    │
│  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘    │
│           │                   │                   │             │
│           ▼                   ▼                   ▼             │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │ 用户领域模型   │  │ 文件传输领域模型│  │ 配置领域模型   │    │
│  └────────┬───────┘  └────────┬───────┘  └────────┬───────┘    │
│           │                   │                   │             │
│           └──────────┬────────┴─────────┬─────────┘             │
│                      │                  │                        │
│                      ▼                  ▼                        │
│           ┌────────────────┐  ┌────────────────┐                │
│           │ 数据访问层     │  │ 外部服务集成   │                │
│           │ (EF Core)      │  │ (STUN/TURN)    │                │
│           └────────┬───────┘  └───────────────┘                 │
│                    │                                            │
│                    ▼                                            │
│           ┌────────────────────┐                                │
│           │      数据库        │                                │
│           └────────────────────┘                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      公共组件                           │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │    │
│  │  │ 日志记录    │  │ 异常处理    │  │ 缓存管理    │      │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 分层架构说明

#### 2.2.1 表示层（Presentation Layer）
- **Web API控制器**：处理HTTP请求，返回响应
- **SignalR Hub**：处理实时通信，如文件传输进度通知
- **前端组件**：用户界面渲染和交互

#### 2.2.2 应用层（Application Layer）
- **应用服务**：实现业务用例，协调领域对象
- **DTO（数据传输对象）**：定义API请求和响应的数据结构
- **验证器**：输入数据验证

#### 2.2.3 领域层（Domain Layer）
- **实体**：核心业务对象
- **聚合根**：领域模型的入口点
- **领域服务**：实现跨实体的业务逻辑
- **仓储接口**：定义数据访问操作
- **领域事件**：实现松耦合的业务流程

#### 2.2.4 基础设施层（Infrastructure Layer）
- **仓储实现**：使用EF Core实现数据访问
- **外部服务**：集成STUN/TURN服务器等外部服务
- **配置管理**：应用配置和环境变量管理

## 3. 核心功能模块

### 3.1 用户管理模块
- **用户注册与登录**：提供用户认证功能
- **角色与权限管理**：控制用户对系统功能的访问权限
- **用户配置管理**：管理用户个性化设置

### 3.2 WebRTC连接管理模块
- **信令服务器**：处理WebRTC信令交换，帮助建立P2P连接
- **连接状态管理**：监控和维护P2P连接状态
- **NAT穿透支持**：集成STUN/TURN服务器，解决NAT穿透问题

### 3.3 文件传输模块
- **文件分块处理**：将大文件分割成小块进行传输
- **数据通道管理**：管理WebRTC数据通道，处理数据传输
- **断点续传机制**：记录传输状态，支持从中断点恢复传输
- **传输进度监控**：实时监控和报告文件传输进度

### 3.4 配置管理模块
- **系统配置**：管理全局系统设置，如最大文件大小限制
- **环境配置**：支持多环境配置（开发、测试、生产）
- **动态配置更新**：支持配置的动态加载和更新

### 3.5 日志与监控模块
- **操作日志**：记录用户操作和系统事件
- **错误日志**：捕获和记录系统错误
- **性能监控**：收集和分析系统性能指标

## 4. 技术选型

### 4.1 后端技术
- **框架**：ABP.io 8.0
- **运行时**：.NET 8.0
- **编程语言**：C# 12
- **ORM**：Entity Framework Core 8.0
- **实时通信**：SignalR
- **认证授权**：JWT、IdentityServer4

### 4.2 前端技术
- **框架**：React/Angular（ABP.io默认）
- **状态管理**：Redux/NGXS
- **UI库**：基于Tailwind CSS的自定义组件
- **实时通信**：SignalR客户端
- **WebRTC**：原生WebRTC API

### 4.3 数据库
- **主要数据库**：SQL Server 2022/PostgreSQL 15
- **缓存**：Redis

### 4.4 部署技术
- **容器化**：Docker
- **编排**：Docker Compose/Kubernetes
- **CI/CD**：GitHub Actions/Azure DevOps

## 5. 项目规划与里程碑

### 5.1 第一阶段：项目初始化（2周）
- 搭建ABP.io项目结构
- 配置开发环境
- 设计数据库模型
- 实现基础认证功能

### 5.2 第二阶段：核心功能开发（4周）
- 实现WebRTC信令服务器
- 开发文件传输核心功能
- 构建前端基础框架
- 实现断点续传机制

### 5.3 第三阶段：功能完善与集成（3周）
- 完善前端用户界面
- 实现配置管理功能
- 开发日志与监控模块
- 进行系统集成测试

### 5.4 第四阶段：测试与部署（2周）
- 性能测试与优化
- 安全测试与修复
- 容器化部署配置
- 文档完善

### 5.5 第五阶段：后续优化（持续）
- 性能优化
- 功能扩展
- 系统维护

## 6. 风险评估与应对策略

### 6.1 技术风险
- **WebRTC兼容性**：不同浏览器对WebRTC支持程度不同
  - 应对策略：进行全面的浏览器兼容性测试，提供降级方案

- **大文件传输性能**：大文件传输可能导致内存占用过高
  - 应对策略：优化文件分块算法，实现流式传输

### 6.2 项目管理风险
- **进度风险**：重构复杂度可能超出预期
  - 应对策略：采用敏捷开发方法，定期检查进度，及时调整计划

- **知识缺口**：团队对ABP.io框架可能不够熟悉
  - 应对策略：提前进行技术培训，参考官方文档和最佳实践

## 7. 扩展与未来规划

### 7.1 近期扩展
- 移动端适配
- 文件预览功能
- 共享链接生成

### 7.2 中长期规划
- 分布式部署支持
- 大规模用户支持
- 企业级特性（如LDAP集成、审计日志等）
- 多租户支持

*注：本文档将随项目进展不断更新和完善。*